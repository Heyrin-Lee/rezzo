<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">
<head>
<meta charset="UTF-8">
<title>ccds.html</title>
<style>
.highlight {
	background : #71b280;
}
</style>
</head>
<body>
	<!-- 본문내용 -->
	<th:block layout:fragment="main">
		<div class="container-fluid px-4">
			<h1 class="mt-4">공통코드관리</h1>
			<ol class="breadcrumb mb-4">
				<li class="breadcrumb-item"><a href="home.do">홈</a></li>
				<li class="breadcrumb-item">> 기준정보관리</li>
				<li class="breadcrumb-item active">> 공통코드관리</li>
			</ol>
			<div class="card mb-4">
				<div class="card-body">
					<label for="" autofocus="autofocus">코드명</label> <input type="text"
						id="selCcd" name="sleCcd" style="width: 150px">
					<button class="btn btn-primary" id="searchBtn">검색</button>
					<div class="linelist" style="text-align: right;">
						<button class="btn btn-primary" id="newBtn">새자료</button>
						<button class="btn btn-primary" id="saveBtn">저장</button>
					</div>
				</div>
			</div>

			<div class="row">
				<div class="col-lg-6" style="width: 35%">
					<div class="card mb-4">
						<div class="card-body">
							<div id="grid"></div>
						</div>
						<div class="card-footer small text-muted"></div>
					</div>
				</div>
				<div class="col-lg-6" style="width: 1%"></div>
				<div class="col-lg-6" style="width: 64%">
					<div class="card mb-4">
						<div class="card-body">
							<!-- 탭 메뉴 -->
							<nav>
								<div class="nav nav-tabs" id="nav-tab" role="tablist">
									<button class="nav-link active" id="nav-codes-tab"
										data-bs-toggle="tab" data-bs-target="#nav-codes" type="button"
										role="tab" aria-controls="nav-codes" aria-selected="true">상세코드</button>
									<button class="nav-link" id="nav-cdInfo-tab"
										data-bs-toggle="tab" data-bs-target="#nav-cdInfo"
										type="button" role="tab" aria-controls="nav-cdInfo"
										aria-selected="false">코드정보</button>
								</div>
							</nav>
							<div class="tab-content" id="nav-tabContent">
								<!-- 상세코드 탭 -->
								<div class="tab-pane fade show active" id="nav-codes"
									role="tabpanel" aria-labelledby="nav-codes-tab">
									<div id="grid2"></div>
								</div>
								<!-- 코드정도 탭 -->
								<div class="tab-pane fade" id="nav-cdInfo" role="tabpanel"
									aria-labelledby="nav-cdInfo-tab">
									<form id="dataForm" name="dataForm" action="#" method="post"
										autocomplete="off">
										<input type="hidden" id="clCode" name="clCode" value="" />
										<table class="table table-bbs table-write" summary="내용.....">
											<colgroup>
												<col style="width: 200x">
												<col>
											</colgroup>
											<tbody>
												<tr>
													<th>공통코드<strong class="blue">*</strong></th>
													<td data-code-id=""><input type="text" id="ccd"
														name="ccd" class="form-control w150" maxlength="10" /></td>
												</tr>
												<tr>
													<th>공통코드명<strong class="blue">*</strong></th>
													<td><input type="text" id="ccdNm" name="ccdNm"
														class="form-control"
														style="width: 300px; background-color: #FFFFCC"
														maxlength="60" /></td>
												</tr>
												<tr>
													<th>코드설명</th>
													<td><textarea id="ccdDesct" name="ccdDesct" rows="5"
															cols="100" class="form-control" maxlength="50"></textarea>
														<span class="letter-limit"> <strong id='limit'>0</strong>/50
															byte
													</span></td>
												</tr>
												<tr>
													<th>사용여부</th>
													<td><select id="useYn" name="useYn"
														style="width: 120px; height: 24px">
															<option value="Y" selected="selected">Yes</option>
															<option value="N">No</option>
													</select></td>
												</tr>
											</tbody>
										</table>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	<!--/* <script src="/js/ccds.js"></script> */-->
	<script>
	// 코드화면(왼쪽) 그리드
const grid = new tui.Grid({
    el: document.getElementById('grid'),
    scrollX: false,
    bodyHeight: 500,
    rowHeaders: ['rowNum'],
    columns: [{
        header: '공통코드',
        name: 'ccd',
        align: 'center',
        sortable: true,
        sortingType: 'desc'
    }, {
        header: '공통코드명',
        name: 'ccdNm',
        align: 'center',
        sortable: true,
        sortingType: 'desc'
    }]
});

$.ajax({
    url: "ccdsList",
    method: "GET",
    dataType: "JSON",
    success: function (result) {
        grid.resetData(result);
    }
});

//상세코드 사용자 커스텀에디터
class CustomTextEditor {
    constructor(props) {
        console.log(props);
        const el = document.createElement('input');
        el.type = 'text';
        el.value = String(props.value);

        this.el = el;
    }

    getElement() {
    		if (this.el.value != 'null') {
    			const newel = document.createElement('span');
    			newel.innerHTML = this.el.value;
    			return newel;
    		} else {
    			this.el.value = '';
        	return this.el;
    		}
    }

    getValue() {
        return this.el.value;
    }

    mounted() {
        this.el.select();
    }
}

//상세코드 그리드
const grid2 = new tui.Grid({
    el: document.getElementById('grid2'),
    scrollX: false,
    bodyHeight: 500,
    rowHeaders: ['checkbox'],
    columns: [{
        header: '코드',
        name: 'ccdDtl',
        align: 'center',
        editor: 'text',
        validation: {
            required: true
          },
        sortable: true,
        sortingType: 'desc'
    }, {
        header: '코드명',
        name: 'ccdDtlNm',
        align: 'center',
        editor: 'text',
        validation: {
            required: true
          },
        sortable: true,
        sortingType: 'desc'
    }, {
        header: '코드설명',
        name: 'ccdDtlDesct',
        align: 'center',
        editor: 'text',
        sortable: true,
        sortingType: 'desc'
    }, {
        header: '사용여부',
        name: 'dtlUseYn',
        editor: {
            type: 'radio',
            options: {
                listItems: [{
                        text: 'Y',
                        value: 'Y'
                    },
                    {
                        text: 'N',
                        value: 'N'
                    }
                ]
            }
        },
        align: 'center',
        sortable: true,
        sortingType: 'desc'
    }]
});

//데이터 편집 후 체크박스
grid2.on('editingFinish', (ev) => {
    var rowKey = ev.rowKey;
    grid2.check(rowKey);
});

//셀 클릭시 로우 하이라이팅
let selectedRowKey = null;
grid.on('focusChange', ev => {
  if (selectedRowKey) {
    grid2.removeRowClassName(selectedRowKey, 'highlight');
  }
  selectedRowKey = ev.rowKey;
  grid2.addRowClassName(selectedRowKey, 'highlight');
});

// 공통코드 클릭시 상세코드 리스트
grid.on('click', ev => {
    var keyword = grid.getValue(ev.rowKey, 'ccdNm');
    var ccd = grid.getValue(ev.rowKey, 'ccd');
    $('#selCcd').val(keyword);

    var rowCount = 0;
    //list 호출
    $.ajax({
        url: "getCodeList",
        method: "POST",
        data: {
            "ccd": ccd
        },
        success: function (result) {
            setTimeout(function () {
                grid2.refreshLayout()
            }, 300);
            grid2.resetData(result);
            rowCount = grid2.getRowCount();
        }
    });

    //기존정보 셀 편집 막기
    grid2.on('dblclick', (ev) => {
    	  const { columnName, rowKey } = ev;
    	  if(columnName == 'ccdDtl' && rowKey < rowCount )
    	  alert('이미 저장된 코드입니다.')
    	});
    
    
    //코드정보 form
    $.ajax({
        url: "ccdInfo",
        method: "POST",
        data: {
            "ccd": ccd
        },
        success: function (result) {
            $('#ccd').val(result.ccd).attr("readonly", true);
            $('#ccdNm').val(result.ccdNm);
            $('#ccdDesct').val(result.ccdDesct);
            $('#useYn').val(result.useYn);
        }
    });

});

//검색버튼
$('#searchBtn').click(ev => {
    search();
})

function search() {
    var keyword = $('#selCcd').val()
    $.ajax({
        url: "ccdsSelect",
        method: "POST",
        data: {
            "keyword": keyword
        },
        success: function (result) {
            grid.resetData(result);
        }
    });
}

//저장버튼
$('#saveBtn').click(ev => {
    //상세코드탭
    if ($('#nav-codes').hasClass("active")) {
        var data = grid2.getCheckedRows();
        var ccd = $('#ccd').val();
        $.ajax({
            url: "/saveCcdDtl/" + ccd,
            type: "POST",
            data: JSON.stringify(data),
            contentType: 'application/json',
            success: function (result) {
                setTimeout(function () {
                    grid2.refreshLayout()
                    grid2.uncheckAll()
                }, 300);
                grid2.resetData(result);
            }
        })
        //코드정보탭
    } else if ($('#nav-cdInfo').hasClass("active")) {
        //추가
        $.ajax({
            url: "ccdsInsert",
            type: "POST",
            data: $('#dataForm').serialize(),
            dataType: 'json',
            success: search()
        })
        //수정
        $.ajax({
            url: "ccdsUpdate",
            type: "POST",
            data: $('#dataForm').serialize(),
            dataType: 'json',
            success: search()
        })
    }
});

//추가버튼
$('#newBtn').click(ev => {
    if ($('#selCcd').val() == '') {
        alert('공통코드를 먼저 선택해주세요!')
    } else {
        //상세코드탭
        if ($('#nav-codes').hasClass("active")) {
            //그리드 추가
            grid2.appendRow();

            //코드정보탭
        } else if ($('#nav-cdInfo').hasClass("active")) {
            //form 초기화
            $('#dataForm')[0].reset();
            $('#ccd').attr("readonly", false);
        }
    }
});

//byte수 출력
$(function () {
    $('#ccdDesct').keyup(function () {
        bytesHandler(this);
    });
});

function getTextLength(str) {
    var len = 0;

    for (var i = 0; i < str.length; i++) {
        if (escape(str.charAt(i)).length == 6) {
            len++;
        }
        len++;
    }
    return len;
}

function bytesHandler(obj) {
    var text = $(obj).val();
    $('#limit').text(getTextLength(text));
}
	</script>
	</th:block>
</body>
</html>