<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.rezzo.mes.resour.insp.mapper.InspMapper">
    <select id="getRscVendList" parameterType="VendVO" resultType="VendVO">
        select VEND_CD, VEND_NM, BIZNO, TELNO
        from VEND
        where VEND_NM like '%${vendNm}%'
          and VEND_CD like '%${vendCd}%'
    </select>

    <select id="getResources" resultType="RscVO">
        select RSC_CD, RSC_NM
        from RSC
        where RSC_NM like '%${rscNm}%'
          and RSC_CD like '%${rscCd}%'
    </select>

    <select id="getRscOrdrList" parameterType="RscOrdrVO" resultType="RscOrdrVO">
        select rod.RSC_CD, rod.RSC_NM, rod.ORDR_CD, rod.ORDR_CNT, rod.RMN_CNT
        from RSC_ORDR ro,
             RSC_ORDR_DTL rod
        where ro.ORDR_CD = rod.ORDR_CD
          and ro.VEND_CD = #{vendCd}
          and rod.RMN_CNT != 0
          and
        <![CDATA[
            PAPRD_CMND_DT >= #{startDt}
          and PAPRD_CMND_DT <= #{endDt}
        ]]>
        order by PAPRD_CMND_DT
    </select>

    <select id="genRscInspCd" resultType="String">
        select 'RMI' || to_char(sysdate, 'YYYYMMDD') || lpad(NVL(max(substr(rsc_insp_cd, 14, 3)), 0) + 1, 3, '0')
        from rsc_insp_dtl where substr(rsc_insp_cd, 4, 8) = to_char(sysdate, 'yyyymmdd')
    </select>

    <insert id="setRscInspList" parameterType="RscInspVO">
        insert into RSC_INSP_DTL (RSC_CD, RSC_INSP_CD, ORDR_CD, INSP_CNT, INSP_PASS_CNT, INSP_FAIL_CNT, PRE_IST_CNT)
        values (#{rscCd}, #{rscInspCd}, #{ordrCd}, #{inspCnt}, #{inspPassCnt}, #{inspFailCnt}, #{preIstCnt})
    </insert>

    <update id="updRscOrdrRmnCnt" parameterType="RscInspVO">
        update RSC_ORDR_DTL
        set RMN_CNT = RMN_CNT - #{preIstCnt}
        where ORDR_CD = #{ordrCd} and RSC_CD = #{rscCd}
    </update>

</mapper>
